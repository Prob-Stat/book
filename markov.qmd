# マルコフ連鎖

## 確率過程とマルコフ連鎖
共通の確率空間 $(\Omega,\,P)$ 上の長さ無限の確率変数列 $X_0,X_1,X_2,\dotsc$ を**離散時間確率過程**という。
各時刻 $t=0,1,2,\dotsc,$ について、 $X_t$ を時刻 $t$ における状態と考える。
離散時間確率過程 $X_0,X_1,\dotsc,$ の各確率変数の像が**有限集合** $S$ であり、
任意の $t\in\mathbb{Z}_{\ge 0}$ と $x_0,\dotsc, x_{t+1}\in S$ について
\begin{align*}
\Pr(X_{t+1} = x_{t+1}\mid X_{t} = x_t,\dotsc,\,X_1=x_1,\,X_0=x_0)
&= \Pr(X_{t+1} = x\mid X_{t} = x_t)
\end{align*}
を満たすとき、それを**有限状態マルコフ連鎖**という。
さらに、
\begin{align*}
\Pr(X_{t+1} = x_{t+1}\mid X_{t} = x_t)
\end{align*}
が $t\in\mathbb{Z}_{\ge 0}$ に依存しないとき**時間的に均一な有限状態マルコフ連鎖**という。
以下では時間的に均一な有限状態マルコフ連鎖を考える。

## 確率行列と状態遷移図

有限状態マルコフ連鎖の場合、状態 $S$ は実数の有限部分集合と考えるより、単に有限集合と考えた方が自然な場合も多い。
例えば $S = \{ 晴れ、曇り、雨\}$ や。
このとき、状態集合を便宜上 $S=\{1,2,\dotsc,n\}$ とおき、
\begin{align*}
p_{i,j} &= \Pr(X_{t+1} = j\mid X_{t} = i)\qquad \forall i,\,j\in S
\end{align*}
とする。
この $p_{i,j}$ を $(i,j)$ 成分に持つ $n\times n$ 行列 $T$ を**遷移行列**という。
遷移行列は非負行列であり、行和が1である。
一般に、この二つの条件を満たす正方行列を**確率行列**という。
確率行列は遷移行列とみなすことができる。

一方で、初期確率からなる行ベクトル $\pi\in\mathbb{R}^{|S|}$ を**初期状態ベクトル**という。
つまり、行ベクトル $\pi$ の $i\in S$ 成分を $\pi_i$ とすると、
\begin{align*}
\pi_i &= \Pr(X_0=i)\qquad i\in S
\end{align*}
である。

初期状態ベクトル $\pi$ と確率行列 $T$ からマルコフ連鎖は定義される。

:::{#exm-whether}
### 天気のマルコフ連鎖

状態集合 $S=\{晴れ、曇り、雨\}$ 上のマルコフ連鎖を考える。
\begin{align*}
\Pr(X_0 = 晴れ) &= 1/3\\
\Pr(X_0 = 曇り) &= 1/2\\
\Pr(X_0 = 雨) &= 1/6\\
\Pr(X_{t+1} = 晴れ\mid X_t=晴れ) &= 1/2\\
\Pr(X_{t+1} = 曇り\mid X_t=晴れ) &= 1/3\\
\Pr(X_{t+1} = 雨\mid X_t=晴れ) &= 1/6\\
\Pr(X_{t+1} = 晴れ\mid X_t=曇り) &= 1/4\\
\Pr(X_{t+1} = 曇り\mid X_t=曇り) &= 1/2\\
\Pr(X_{t+1} = 雨\mid X_t=曇り) &= 1/4\\
\Pr(X_{t+1} = 晴れ\mid X_t=雨) &= 1/3\\
\Pr(X_{t+1} = 曇り\mid X_t=雨) &= 1/3\\
\Pr(X_{t+1} = 雨\mid X_t=雨) &= 1/3\\
\end{align*}
と初期確率と遷移確率が与えられているとする。
このとき、
\begin{align*}
晴れ&\longleftrightarrow 1&
曇り&\longleftrightarrow 2&
雨&\longleftrightarrow 3&
\end{align*}
と対応させると、初期状態ベクトル $\pi$ と遷移行列 $T$ は
\begin{align*}
\pi&=
\begin{bmatrix}
1/3&1/2&1/6
\end{bmatrix}&
T&=
\begin{bmatrix}
1/2&1/3&1/6\\
1/4&1/2&1/4\\
1/3&1/3&1/3
\end{bmatrix}
\end{align*}
である。
:::

確率の遷移確率を有向グラフで表したものを**状態遷移図**という。
上記の天気のマルコフ連鎖の状態遷移図は以下の通りである。
状態遷移図において遷移確率が0の有向辺は通常は描かない。
```{dot}
digraph Markov {
  rankdir=LR;
  node [shape=circle, width=0.5, height=0.5, fontsize=7];

  1 [label="晴れ"]
  2 [label="曇り"]
  3 [label="雨"]

  1 -> 1 [label="1/2"];
  1 -> 2 [label="1/3"];
  1 -> 3 [label="1/6"];

  2 -> 1 [label="1/4"];
  2 -> 2 [label="1/2"];
  2 -> 3 [label="1/4"];

  3 -> 1 [label="1/3"];
  3 -> 2 [label="1/3"];
  3 -> 3 [label="1/3"];
}
```


## 時刻 $t$ の確率分布
初期状態ベクトル $\pi$ と遷移行列 $T$ が与えられているとき、$X_1$ の確率は
\begin{align*}
\Pr(X_1=j) &= \sum_{i\in S} \Pr(X_0=i) \Pr(X_1=j\mid X_0=i)\\
&=\sum_{i\in S} \pi_i\, p_{i, j}\\
&=(\pi T)_j
\end{align*}
と表せる。よって、
\begin{align*}
\Pr(X_n=j) &= (\pi T^n)_j
\end{align*}
である。

任意の遷移行列 $T$ とすべて1の列ベクトル $\mathrm{1}\in\mathbb{R}^{|S|}$ について、
\begin{align*}
T \mathrm{1} = \mathrm{1}
\end{align*}
である。よって $T$ は固有値1を持つ。
よって $T-I$ は正則ではないので、左固有ベクトル $\mu$ を持つ。
つまり、
\begin{align*}
\mu T = \mu
\end{align*}
を満たす $\mu$ が存在する。
この $\mu$ を**定常確率ベクトル**という。


<!--
この確率について、

1. もっと単純な数式で表す。
1. 効率的なアルゴリズムを与える。
1. $n\to\infty$ の漸近

遷移行列 $T$ が $T=UDU^{-1}$ と対角化できるとき、
-->

## グラフ上のランダムウォーク
:::{#def-graph}
### グラフ
有限集合 $V$ と集合 $E\subseteq \{\{u,v\}\mid u,\, v\in V, u\ne v\}$ のペア $G=(V,\,E)$ を(無向単純)グラフという。
$V$ の元を**頂点**、$E$ の元を**辺**と呼ぶ。
:::

グラフ $G=(V,\,E)$ と $v\in V$ について、
\begin{align*}
d_v&=|\{u\in V\mid \{u,v\}\in E\}|
\end{align*}
を $v$ の**次数**という。
次数0の頂点を**孤立頂点**という。

:::{#def-rw}
### グラフ上のランダムウォーク
孤立頂点を持たないグラフ $G=(V=\{1,2,\dotsc,n\},\,E)$ 上のランダムウォークは $S=V$ であり、
任意の初期確率ベクトル $\pi$ と
\begin{align*}
p_{i,j} &= \frac1{d_i}
\end{align*}
で定義される。
:::

:::{#lem-rw}
グラフ上のランダムウォークの遷移行列は対角化可能であり、固有値はすべて実数である。
:::
:::{.proof}
グラフ $G$ の次数行列を
\begin{align*}
D_{i,j} &= d_i\delta_{i,j}
\end{align*}
と定義する。
\begin{align*}
Q &= \sqrt{D} P \sqrt{D}^{-1}
\end{align*}
と
:::

## 確率の計算アルゴリズム

:::{#def-fps}
### 形式的冪級数
:::

時刻 $n$ で状態 $j$ の確率
\begin{align*}
\Pr(X_n=j) &= (\pi T^n)_j
\end{align*}
を計算するアルゴリズムを考える。
\begin{align*}
\Pr(X_n=j) &= (\pi T^n)_j\\
&= \left( [x^n] \sum_{t\ge 0}\pi T^t x^t\right)_j
\end{align*}

